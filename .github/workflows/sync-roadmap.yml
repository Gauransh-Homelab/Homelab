name: Sync Roadmap from Jira

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: sync-roadmap
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Jira and Update README
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        shell: bash
        run: |
          # Get board ID for KAN project
          BOARD_ID=$(curl -s \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "https://arkhaya.atlassian.net/rest/agile/1.0/board?projectKeyOrId=KAN" \
            | jq '.values[0].id')

          if [ "$BOARD_ID" = "null" ] || [ -z "$BOARD_ID" ]; then
            echo "Could not find board for KAN project"
            exit 1
          fi
          echo "Board ID: $BOARD_ID"

          # Fetch all board issues
          curl -s \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "https://arkhaya.atlassian.net/rest/agile/1.0/board/${BOARD_ID}/issue?fields=summary,status&maxResults=100" \
            > jira_all.json

          # Fetch backlog issues to exclude them
          curl -s \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "https://arkhaya.atlassian.net/rest/agile/1.0/board/${BOARD_ID}/backlog?fields=key&maxResults=100" \
            > jira_backlog.json

          # Get backlog keys and filter them out
          BACKLOG_KEYS=$(jq -r '[.issues[].key]' jira_backlog.json)
          jq --argjson backlog "$BACKLOG_KEYS" '{issues: [.issues[] | select(.key as $k | $backlog | index($k) | not)]}' jira_all.json > jira_response.json

          ISSUE_COUNT=$(jq '.issues | length' jira_response.json)
          echo "Found $ISSUE_COUNT board issues (excluded $(jq '.issues | length' jira_backlog.json) backlog items)"

          TODO=$(jq -r '.issues[] | select(.fields.status.name == "To Do") | "- \(.fields.summary)<br>"' jira_response.json)
          PROGRESS=$(jq -r '.issues[] | select(.fields.status.name == "In Progress") | "- \(.fields.summary)<br>"' jira_response.json)
          DONE=$(jq -r '.issues[] | select(.fields.status.name == "Done") | "- \(.fields.summary)<br>"' jira_response.json)

          TODO_COUNT=$(echo "$TODO" | grep -c '<br>' || true)
          PROGRESS_COUNT=$(echo "$PROGRESS" | grep -c '<br>' || true)
          DONE_COUNT=$(echo "$DONE" | grep -c '<br>' || true)

          [ -z "$TODO" ] && TODO="<em>No items</em>"
          [ -z "$PROGRESS" ] && PROGRESS="<em>No items</em>"
          [ -z "$DONE" ] && DONE="<em>No items</em>"

          {
            echo '## ðŸ“‹ Roadmap'
            echo ''
            echo '<div align="center">'
            echo ''
            echo '<em>Synced from <a href="https://arkhaya.atlassian.net/jira/software/projects/KAN/board">Jira</a> â€¢ Updates every 6 hours and on push</em>'
            echo ''
            echo '</div>'
            echo ''
            echo '<table>'
            echo '<tr>'
            echo '<td valign="top" width="33%">'
            echo ''
            echo "<h3>To Do (${TODO_COUNT})</h3>"
            echo ''
            echo "$TODO"
            echo ''
            echo '</td>'
            echo '<td valign="top" width="33%">'
            echo ''
            echo "<h3>In Progress (${PROGRESS_COUNT})</h3>"
            echo ''
            echo "$PROGRESS"
            echo ''
            echo '</td>'
            echo '<td valign="top" width="33%">'
            echo ''
            echo "<h3>Done (${DONE_COUNT})</h3>"
            echo ''
            echo "$DONE"
            echo ''
            echo '</td>'
            echo '</tr>'
            echo '</table>'
            echo ''
            echo '---'
          } > roadmap.tmp

          awk '/^## ðŸ“‹ Roadmap$/{exit} 1' README.md > readme_before.tmp

          awk '
            /^## ðŸ“‹ Roadmap$/ {in_roadmap=1}
            in_roadmap && /^---$/ {found_end=1}
            found_end && /^## / {capture=1}
            capture {print}
          ' README.md > readme_after.tmp

          cat readme_before.tmp roadmap.tmp readme_after.tmp > README.md
          rm -f *.tmp jira_*.json

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet README.md; then
            echo "No changes to README.md"
            exit 0
          fi

          git add README.md
          git commit -m "ðŸ”„ Sync roadmap from Jira [skip ci]"

          if ! git push origin main; then
            echo "Push failed - likely due to concurrent changes. Skipping."
          fi
