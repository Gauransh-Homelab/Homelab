name: Sync Roadmap from Jira

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: sync-roadmap
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Jira and Update README
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        shell: bash
        run: |
          curl -s -X POST \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{"jql":"project = KAN ORDER BY created DESC","fields":["summary","status","issuetype"],"maxResults":100}' \
            "https://arkhaya.atlassian.net/rest/api/3/search/jql" \
            > jira_response.json

          ISSUE_COUNT=$(jq '.issues | length' jira_response.json)
          if [ "$ISSUE_COUNT" -eq 0 ] || [ "$ISSUE_COUNT" = "null" ]; then
            echo "No issues found or API error"
            cat jira_response.json
            exit 1
          fi
          echo "Found $ISSUE_COUNT issues"

          JQ_FILTER='"\(if .fields.issuetype.name == "Story" then "üìñ" elif .fields.issuetype.name == "Bug" then "üêõ" elif .fields.issuetype.name == "Epic" then "üöÄ" else "‚úÖ" end) \(.fields.summary)<br>"'

          TODO=$(jq -r ".issues[] | select(.fields.status.name == \"To Do\") | $JQ_FILTER" jira_response.json)
          PROGRESS=$(jq -r ".issues[] | select(.fields.status.name == \"In Progress\") | $JQ_FILTER" jira_response.json)
          DONE=$(jq -r ".issues[] | select(.fields.status.name == \"Done\") | $JQ_FILTER" jira_response.json)

          TODO_COUNT=$(echo "$TODO" | grep -c '<br>' || true)
          PROGRESS_COUNT=$(echo "$PROGRESS" | grep -c '<br>' || true)
          DONE_COUNT=$(echo "$DONE" | grep -c '<br>' || true)

          [ -z "$TODO" ] && TODO="<em>No items</em>"
          [ -z "$PROGRESS" ] && PROGRESS="<em>No items</em>"
          [ -z "$DONE" ] && DONE="<em>No items</em>"

          {
            echo '## üìã Roadmap'
            echo ''
            echo '<div align="center">'
            echo ''
            echo '<em>Synced from <a href="https://arkhaya.atlassian.net/jira/software/projects/KAN/board">Jira</a> ‚Ä¢ Updates every 6 hours and on push</em>'
            echo ''
            echo '</div>'
            echo ''
            echo '<table>'
            echo '<tr>'
            echo '<td valign="top" width="33%">'
            echo ''
            echo "<h3>üìã To Do (${TODO_COUNT})</h3>"
            echo ''
            echo "$TODO"
            echo ''
            echo '</td>'
            echo '<td valign="top" width="33%">'
            echo ''
            echo "<h3>üöß In Progress (${PROGRESS_COUNT})</h3>"
            echo ''
            echo "$PROGRESS"
            echo ''
            echo '</td>'
            echo '<td valign="top" width="33%">'
            echo ''
            echo "<h3>‚úÖ Done (${DONE_COUNT})</h3>"
            echo ''
            echo "$DONE"
            echo ''
            echo '</td>'
            echo '</tr>'
            echo '</table>'
            echo ''
            echo '---'
          } > roadmap.tmp

          awk '/^## üìã Roadmap$/{exit} 1' README.md > readme_before.tmp

          awk '
            /^## üìã Roadmap$/ {in_roadmap=1}
            in_roadmap && /^---$/ {found_end=1}
            found_end && /^## / {capture=1}
            capture {print}
          ' README.md > readme_after.tmp

          cat readme_before.tmp roadmap.tmp readme_after.tmp > README.md
          rm -f *.tmp jira_response.json

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet README.md; then
            echo "No changes to README.md"
            exit 0
          fi

          git add README.md
          git commit -m "üîÑ Sync roadmap from Jira [skip ci]"

          if ! git push origin main; then
            echo "Push failed - likely due to concurrent changes. Skipping."
          fi
