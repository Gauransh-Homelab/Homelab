name: Sync Roadmap from Jira

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: sync-roadmap
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Jira and Update README
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          # Fetch all issues from KAN project
          curl -s \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Accept: application/json" \
            "https://arkhaya.atlassian.net/rest/api/3/search?jql=project%3DKAN%20ORDER%20BY%20created%20DESC&fields=summary,status,issuetype&maxResults=100" \
            > jira_response.json

          TOTAL=$(jq '.total // 0' jira_response.json)
          if [ "$TOTAL" -eq 0 ]; then
            echo "No issues found or API error"
            cat jira_response.json
            exit 1
          fi
          echo "Found $TOTAL issues"

          # Build items per column using jq
          TODO=$(jq -r '.issues[] | select(.fields.status.name == "To Do") | "\(if .fields.issuetype.name == "Story" then "ğŸ“–" elif .fields.issuetype.name == "Bug" then "ğŸ›" elif .fields.issuetype.name == "Epic" then "ğŸš€" else "âœ…" end) \(.fields.summary)<br>"' jira_response.json)
          PROGRESS=$(jq -r '.issues[] | select(.fields.status.name == "In Progress") | "\(if .fields.issuetype.name == "Story" then "ğŸ“–" elif .fields.issuetype.name == "Bug" then "ğŸ›" elif .fields.issuetype.name == "Epic" then "ğŸš€" else "âœ…" end) \(.fields.summary)<br>"' jira_response.json)
          DONE=$(jq -r '.issues[] | select(.fields.status.name == "Done") | "\(if .fields.issuetype.name == "Story" then "ğŸ“–" elif .fields.issuetype.name == "Bug" then "ğŸ›" elif .fields.issuetype.name == "Epic" then "ğŸš€" else "âœ…" end) \(.fields.summary)<br>"' jira_response.json)

          TODO_COUNT=$(echo "$TODO" | grep -c '<br>' || true)
          PROGRESS_COUNT=$(echo "$PROGRESS" | grep -c '<br>' || true)
          DONE_COUNT=$(echo "$DONE" | grep -c '<br>' || true)

          [ -z "$TODO" ] && TODO="<em>No items</em>"
          [ -z "$PROGRESS" ] && PROGRESS="<em>No items</em>"
          [ -z "$DONE" ] && DONE="<em>No items</em>"

          # Build roadmap section
          cat > roadmap.tmp << EOF
## ğŸ“‹ Roadmap

<div align="center">

<em>Synced from <a href="https://arkhaya.atlassian.net/jira/software/projects/KAN/board">Jira</a> â€¢ Updates every 6 hours and on push</em>

</div>

<table>
<tr>
<td valign="top" width="33%">

<h3>ğŸ“‹ To Do (${TODO_COUNT})</h3>

${TODO}

</td>
<td valign="top" width="33%">

<h3>ğŸš§ In Progress (${PROGRESS_COUNT})</h3>

${PROGRESS}

</td>
<td valign="top" width="33%">

<h3>âœ… Done (${DONE_COUNT})</h3>

${DONE}

</td>
</tr>
</table>

---
EOF

          # Save content before roadmap
          awk '/^## ğŸ“‹ Roadmap$/{exit} 1' README.md > readme_before.tmp

          # Save content after roadmap
          awk '
            /^## ğŸ“‹ Roadmap$/ {in_roadmap=1}
            in_roadmap && /^---$/ {found_end=1}
            found_end && /^## / {capture=1}
            capture {print}
          ' README.md > readme_after.tmp

          # Combine
          cat readme_before.tmp roadmap.tmp readme_after.tmp > README.md

          # Cleanup
          rm -f *.tmp jira_response.json

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet README.md; then
            echo "No changes to README.md"
            exit 0
          fi

          git add README.md
          git commit -m "ğŸ”„ Sync roadmap from Jira [skip ci]"

          if ! git push origin main; then
            echo "Push failed - likely due to concurrent changes. Skipping."
          fi
