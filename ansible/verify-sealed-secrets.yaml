---
- name: Sealed Secrets - Audit, Seal, and Verify
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    repo_root: "{{ playbook_dir }}/.."
    audit_results: []
    # Set to true to seal plain secrets, delete old, and apply new
    # Usage: ansible-playbook verify-sealed-secrets.yaml -e seal=true
    seal: false

  tasks:
    # ── Discover all secret files recursively ───────────────────────
    - name: Find all files with 'secret' in the name
      find:
        paths:
          - "{{ repo_root }}/kubernetes"
          - "{{ repo_root }}/helm"
        patterns: "*secret*"
        recurse: true
        file_type: file
        excludes:
          - "*.md"
      register: secret_files

    - name: Read contents of each secret file
      slurp:
        src: "{{ item.path }}"
      loop: "{{ secret_files.files }}"
      loop_control:
        label: "{{ item.path | regex_replace(repo_root + '/', '') }}"
      register: file_contents

    - name: Parse and classify each file
      set_fact:
        audit_results: >-
          {{
            audit_results + [{
              'file': item.item.path | regex_replace(repo_root + '/', ''),
              'full_path': item.item.path,
              'kind': (item.content | b64decode | from_yaml_all | list | first).kind | default('Unknown'),
              'api_version': (item.content | b64decode | from_yaml_all | list | first).apiVersion | default('Unknown'),
              'name': (item.content | b64decode | from_yaml_all | list | first).metadata.name | default('Unknown'),
              'namespace': (item.content | b64decode | from_yaml_all | list | first).metadata.namespace | default('Unknown'),
              'is_sealed': ((item.content | b64decode | from_yaml_all | list | first).kind | default('')) == 'SealedSecret',
              'is_plain_secret': ((item.content | b64decode | from_yaml_all | list | first).kind | default('')) == 'Secret',
              'is_not_secret': ((item.content | b64decode | from_yaml_all | list | first).kind | default('')) not in ['Secret', 'SealedSecret']
            }]
          }}
      loop: "{{ file_contents.results }}"
      loop_control:
        label: "{{ item.item.path | regex_replace(repo_root + '/', '') }}"
      ignore_errors: true

    # ── Report: Already sealed ──────────────────────────────────────
    - name: "SEALED - Already converted"
      debug:
        msg: "{{ item.file }} -> {{ item.name }} ({{ item.namespace }})"
      loop: "{{ audit_results | selectattr('is_sealed') | list }}"
      loop_control:
        label: "{{ item.file }}"

    # ── Report: Plain secrets that need conversion ──────────────────
    - name: "PLAIN SECRET - Needs sealing"
      debug:
        msg: "{{ item.file }} -> {{ item.name }} ({{ item.namespace }})"
      loop: "{{ audit_results | selectattr('is_plain_secret') | list }}"
      loop_control:
        label: "{{ item.file }}"

    # ── Report: Not actually secrets ────────────────────────────────
    - name: "NOT A SECRET - Misnamed file"
      debug:
        msg: "{{ item.file }} -> Kind: {{ item.kind }}"
      loop: "{{ audit_results | selectattr('is_not_secret') | list }}"
      loop_control:
        label: "{{ item.file }}"

    # ══════════════════════════════════════════════════════════════════
    # SEAL MODE: Convert plain secrets to sealed secrets
    # ══════════════════════════════════════════════════════════════════

    - name: "SEAL MODE - Sealing {{ audit_results | selectattr('is_plain_secret') | list | length }} plain secret(s)"
      debug:
        msg: "Starting seal operations..."
      when: seal | bool and audit_results | selectattr('is_plain_secret') | list | length > 0

    # Step 1: Seal each plain secret with kubeseal
    - name: "Seal plain secret with kubeseal"
      command: >
        kubeseal --format yaml
        --controller-name sealed-secrets
        --controller-namespace kube-system
      args:
        stdin: "{{ lookup('file', item.full_path) }}"
      loop: "{{ audit_results | selectattr('is_plain_secret') | list }}"
      loop_control:
        label: "{{ item.file }}"
      register: sealed_outputs
      when: seal | bool

    # Step 2: Overwrite the original file with the sealed version
    - name: "Write sealed secret back to file"
      copy:
        content: "{{ item.stdout }}"
        dest: "{{ (audit_results | selectattr('is_plain_secret') | list)[idx].full_path }}"
      loop: "{{ sealed_outputs.results | default([]) }}"
      loop_control:
        index_var: idx
        label: "{{ (audit_results | selectattr('is_plain_secret') | list)[idx].file }}"
      when: seal | bool and item.stdout is defined

    # Step 3: Delete existing secret from cluster (ignore if not exists)
    - name: "Delete existing Secret from cluster"
      kubernetes.core.k8s:
        api_version: v1
        kind: Secret
        name: "{{ item.name }}"
        namespace: "{{ item.namespace }}"
        state: absent
      loop: "{{ audit_results | selectattr('is_plain_secret') | list }}"
      loop_control:
        label: "{{ item.name }} ({{ item.namespace }})"
      ignore_errors: true
      when: seal | bool

    # Step 4: Apply the new SealedSecret to the cluster (ignore missing namespaces)
    - name: "Apply SealedSecret to cluster"
      kubernetes.core.k8s:
        state: present
        src: "{{ item.full_path }}"
      loop: "{{ audit_results | selectattr('is_plain_secret') | list }}"
      loop_control:
        label: "{{ item.name }} ({{ item.namespace }})"
      register: apply_results
      ignore_errors: true
      when: seal | bool

    # Step 5: Wait for controller to process
    - name: "Wait for sealed-secrets controller to process"
      pause:
        seconds: 5
      when: seal | bool and audit_results | selectattr('is_plain_secret') | list | length > 0

    # ══════════════════════════════════════════════════════════════════
    # VERIFICATION: Check all sealed secrets in cluster
    # ══════════════════════════════════════════════════════════════════

    # Re-read files after potential sealing to get updated classification
    - name: Re-read files after sealing
      slurp:
        src: "{{ item.path }}"
      loop: "{{ secret_files.files }}"
      loop_control:
        label: "{{ item.path | regex_replace(repo_root + '/', '') }}"
      register: file_contents_updated
      when: seal | bool

    - name: Re-classify files after sealing
      set_fact:
        audit_results_updated: >-
          {{
            (audit_results_updated | default([])) + [{
              'file': item.item.path | regex_replace(repo_root + '/', ''),
              'full_path': item.item.path,
              'kind': (item.content | b64decode | from_yaml_all | list | first).kind | default('Unknown'),
              'name': (item.content | b64decode | from_yaml_all | list | first).metadata.name | default('Unknown'),
              'namespace': (item.content | b64decode | from_yaml_all | list | first).metadata.namespace | default('Unknown'),
              'is_sealed': ((item.content | b64decode | from_yaml_all | list | first).kind | default('')) == 'SealedSecret'
            }]
          }}
      loop: "{{ file_contents_updated.results | default([]) }}"
      loop_control:
        label: "{{ item.item.path | regex_replace(repo_root + '/', '') }}"
      ignore_errors: true
      when: seal | bool

    # Use updated results if we sealed, otherwise use original
    - name: Set final results for verification
      set_fact:
        verify_list: "{{ (audit_results_updated | default(audit_results)) | selectattr('is_sealed') | list }}"

    - name: Check sealed-secrets controller is running
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: kube-system
        label_selectors:
          - "app.kubernetes.io/name=sealed-secrets"
      register: controller_pods
      when: verify_list | length > 0

    - name: Validate sealed-secrets controller
      assert:
        that:
          - controller_pods.resources | length > 0
          - controller_pods.resources[0].status.phase == "Running"
        fail_msg: "Sealed-secrets controller is not running!"
        success_msg: "Sealed-secrets controller is running"
      when: verify_list | length > 0

    - name: Verify each SealedSecret is synced in cluster
      kubernetes.core.k8s_info:
        api_version: bitnami.com/v1alpha1
        kind: SealedSecret
        name: "{{ item.name }}"
        namespace: "{{ item.namespace }}"
      loop: "{{ verify_list }}"
      loop_control:
        label: "{{ item.name }} ({{ item.namespace }})"
      register: cluster_sealed
      when: verify_list | length > 0

    - name: Verify decrypted Secret exists for each SealedSecret
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ item.name }}"
        namespace: "{{ item.namespace }}"
      loop: "{{ verify_list }}"
      loop_control:
        label: "{{ item.name }} ({{ item.namespace }})"
      register: cluster_secrets
      when: verify_list | length > 0

    # ── Summary ─────────────────────────────────────────────────────
    - name: Display audit summary
      debug:
        msg: |
          ══════════════════════════════════════════════
           Sealed Secrets Audit Summary
          ══════════════════════════════════════════════
           Total files scanned:  {{ audit_results | length }}
           Already sealed:       {{ audit_results | selectattr('is_sealed') | list | length }}
           Plain secrets:        {{ audit_results | selectattr('is_plain_secret') | list | length }}
           Not a secret:         {{ audit_results | selectattr('is_not_secret') | list | length }}
           Seal mode:            {{ 'ENABLED' if seal | bool else 'DISABLED (use -e seal=true)' }}
          ══════════════════════════════════════════════
      when: not seal | bool

    - name: Display seal summary
      debug:
        msg: |
          ══════════════════════════════════════════════
           Sealed Secrets - Seal Complete
          ══════════════════════════════════════════════
           Sealed this run:      {{ audit_results | selectattr('is_plain_secret') | list | length }}
           Total now sealed:     {{ verify_list | length }}
           Verified in cluster:  {{ cluster_sealed.results | default([]) | selectattr('resources', 'defined') | list | length }}
          ══════════════════════════════════════════════
      when: seal | bool
