---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
  namespace: misc
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: external-dns
  template:
    metadata:
      labels:
        app: external-dns
    spec:
      serviceAccountName: external-dns
      initContainers:
      # Wait for Pi-hole API to be ready before starting webhook
      - name: wait-for-pihole
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          echo "Waiting for Pi-hole API to be ready..."
          until nc -z 192.168.10.101 8000; do
            echo "Pi-hole not ready, waiting..."
            sleep 2
          done
          echo "Pi-hole port is open, waiting 10 seconds for API to stabilize..."
          sleep 10
          echo "Ready to start webhook"
      containers:
      # Pi-hole webhook sidecar
      - name: pihole-webhook
        image: ghcr.io/tarantini-io/external-dns-pihole-webhook:main
        ports:
        - containerPort: 8888
          name: http-webhook
          protocol: TCP
        env:
        - name: PIHOLE_SERVER
          value: "http://192.168.10.101:8000"
        - name: PIHOLE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: pihole-password
              key: EXTERNAL_DNS_PIHOLE_PASSWORD
        - name: LOG_LEVEL
          value: "debug"
        - name: SERVER_HOST
          value: "0.0.0.0"
        - name: SERVER_PORT
          value: "8888"
        livenessProbe:
          httpGet:
            path: /healthz
            port: http-webhook
          initialDelaySeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /readyz
            port: http-webhook
          initialDelaySeconds: 20
          timeoutSeconds: 5
          failureThreshold: 3
      # External-DNS main container
      - name: external-dns
        image: registry.k8s.io/external-dns/external-dns:v0.20.0
        args:
        - --source=service
        - --source=ingress
        - --source=traefik-proxy
        # Use webhook provider instead of pihole
        - --provider=webhook
        # Webhook endpoint (sidecar on IPv4 loopback)
        - --webhook-provider-url=http://127.0.0.1:8888
        # Use noop registry (no TXT records - webhook doesn't support them)
        - --registry=noop
        # IMPORTANT: upsert-only policy to avoid deleting manually managed records
        - --policy=upsert-only
        # Only sync records for your domain
        - --domain-filter=arkhaya.duckdns.org
        # Sync interval
        - --interval=1m
        # Log level
        - --log-level=debug
        # Disable legacy Traefik API
        - --traefik-disable-legacy
      securityContext:
        fsGroup: 65534
